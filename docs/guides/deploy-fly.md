# Deploying djust on Fly.io

This guide covers deploying a djust LiveView application to [Fly.io](https://fly.io) with full WebSocket support.

## Prerequisites

- A Fly.io account ([fly.io](https://fly.io))
- The Fly CLI installed (`brew install flyctl` or `curl -L https://fly.io/install.sh | sh`)
- A djust project ready for deployment
- Git repository initialized

## Project Configuration

### requirements.txt

Ensure your `requirements.txt` (or `pyproject.toml`) includes production dependencies:

```
djust>=0.3.0
Django>=4.2
channels[daphne]>=4.0.0
uvicorn[standard]>=0.30.0
whitenoise>=6.0.0
redis>=5.0.0
channels-redis>=4.1.0
psycopg2-binary>=2.9.0
dj-database-url>=2.0.0
gunicorn>=21.0.0
```

### Dockerfile

Create a `Dockerfile` in your project root:

```dockerfile
FROM python:3.11-slim-bookworm

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    libpq5 \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy project
COPY . .

# Collect static files
RUN python manage.py collectstatic --noinput

# Create non-root user
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

EXPOSE 8000

CMD ["uvicorn", "myproject.asgi:application", "--host", "0.0.0.0", "--port", "8000"]
```

Replace `myproject` with your Django project name.

### Production Settings

Update your `settings.py` for production:

```python
import os
import dj_database_url

# Security
SECRET_KEY = os.environ["SECRET_KEY"]
DEBUG = os.environ.get("DEBUG", "false").lower() == "true"
ALLOWED_HOSTS = os.environ.get("ALLOWED_HOSTS", ".fly.dev").split(",")
CSRF_TRUSTED_ORIGINS = [
    f"https://{host}" for host in ALLOWED_HOSTS if host
]

# Database (Fly Postgres provides DATABASE_URL)
DATABASES = {
    "default": dj_database_url.config(
        default=os.environ.get("DATABASE_URL", "sqlite:///db.sqlite3"),
        conn_max_age=600,
    )
}

# Redis (Fly Upstash Redis provides REDIS_URL)
REDIS_URL = os.environ.get("REDIS_URL", "redis://localhost:6379/0")

# Django Channels â€” required for djust WebSocket support
CHANNEL_LAYERS = {
    "default": {
        "BACKEND": "channels_redis.core.RedisChannelLayer",
        "CONFIG": {
            "hosts": [REDIS_URL],
        },
    },
}

# djust state backend
DJUST_CONFIG = {
    "STATE_BACKEND": "redis",
    "REDIS_URL": REDIS_URL,
    "SESSION_TTL": 7200,
}

# Static files (WhiteNoise)
STATIC_URL = "/static/"
STATIC_ROOT = os.path.join(BASE_DIR, "staticfiles")
STATICFILES_STORAGE = "whitenoise.storage.CompressedManifestStaticFilesStorage"

MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "whitenoise.middleware.WhiteNoiseMiddleware",
    # ... rest of your middleware
]
```

### ASGI Configuration

Ensure your `asgi.py` includes djust routing:

```python
import os
import django

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "myproject.settings")
django.setup()

from channels.routing import ProtocolTypeRouter, URLRouter
from channels.auth import AuthMiddlewareStack
from django.core.asgi import get_asgi_application
from djust.routing import live_session

application = ProtocolTypeRouter({
    "http": get_asgi_application(),
    "websocket": AuthMiddlewareStack(
        URLRouter(
            live_session(your_urlpatterns)
        )
    ),
})
```

## WebSocket Setup

Fly.io natively supports WebSocket connections. Key points:

- Fly's Anycast network routes traffic to the nearest edge, then to your app via WireGuard
- TLS is terminated at the edge; your app receives plain connections
- No special proxy headers or timeout configuration is needed
- Long-lived WebSocket connections work out of the box

### fly.toml Configuration

The `fly.toml` generated by `fly launch` handles WebSocket support automatically. Verify these settings:

```toml
[http_service]
  internal_port = 8000
  force_https = true
  auto_stop_machines = false   # Keep machines running for WebSocket connections
  auto_start_machines = true
  min_machines_running = 1     # At least 1 machine for WebSocket availability

  [http_service.concurrency]
    type = "connections"
    hard_limit = 250
    soft_limit = 200
```

Setting `auto_stop_machines = false` is important for djust apps. If machines stop, all active WebSocket connections drop and LiveView state is lost.

## Database Setup

Create a Fly Postgres cluster:

```bash
fly postgres create --name myproject-db
fly postgres attach myproject-db
```

This automatically sets the `DATABASE_URL` secret on your app.

Run migrations:

```bash
fly ssh console -C "python manage.py migrate"
```

## Redis Setup

Create a Redis instance using Fly's Upstash Redis integration:

```bash
fly redis create --name myproject-redis
```

This sets the `REDIS_URL` secret on your app. Both the channel layer and djust state backend will use this Redis instance.

## Step-by-Step Deployment

### 1. Launch the Fly app

```bash
fly auth login
fly launch
```

The `fly launch` command detects your Django project and generates `fly.toml` and a `Dockerfile` (if you do not already have one). Review the generated files and adjust as needed.

### 2. Set secrets

```bash
fly secrets set SECRET_KEY=$(python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())")
fly secrets set DJANGO_SETTINGS_MODULE=myproject.settings
fly secrets set ALLOWED_HOSTS=.fly.dev
```

### 3. Add PostgreSQL and Redis

```bash
fly postgres create --name myproject-db
fly postgres attach myproject-db

fly redis create --name myproject-redis
```

### 4. Deploy

```bash
fly deploy
```

### 5. Run migrations and create superuser

```bash
fly ssh console -C "python manage.py migrate"
fly ssh console -C "python manage.py createsuperuser"
```

### 6. Verify WebSocket connectivity

Open your deployed app at `https://myproject.fly.dev` and check the browser console. You should see the djust WebSocket connection established without errors.

## Scaling

Fly.io makes horizontal scaling straightforward:

```bash
# Scale to multiple machines
fly scale count 2

# Scale machine size
fly scale vm shared-cpu-2x
```

When running multiple machines, ensure Redis is configured for both the channel layer and djust state backend so that state is shared across instances.

## Troubleshooting

### WebSocket connection fails with 404

- Verify your `asgi.py` includes WebSocket routing
- Ensure the Dockerfile CMD uses an ASGI server (uvicorn/daphne), not gunicorn with WSGI
- Check that `internal_port` in `fly.toml` matches the port in your CMD

### Machines keep stopping

- Set `auto_stop_machines = false` in `fly.toml` to prevent Fly from stopping machines with active WebSocket connections
- Set `min_machines_running = 1` to ensure at least one machine is always available

### Application crashes on startup

- Check logs: `fly logs`
- Verify all secrets are set: `fly secrets list`
- SSH into the machine to debug: `fly ssh console`

### Static files not loading

- Confirm `whitenoise` is in your middleware (after `SecurityMiddleware`)
- Verify the Dockerfile runs `collectstatic` during build
- Check that `STATIC_ROOT` is set in settings

### Redis connection errors

- Verify Redis was created and attached: `fly redis list`
- Check that `REDIS_URL` is in your secrets: `fly secrets list`
- Ensure `redis` and `channels-redis` packages are installed

### Database connection errors

- Verify Postgres is attached: `fly postgres list`
- Check the internal connection string: `fly ssh console -C "echo $DATABASE_URL"`
- Ensure `psycopg2-binary` is in your requirements

## Further Reading

- [Fly.io Django Documentation](https://fly.io/docs/django/)
- [Fly.io Django Beats Blog](https://fly.io/django-beats/)
- [ASGI Deployment Options for Django](https://fly.io/django-beats/asgi-deployment-options-for-django/)
- [djust Deployment Guide](./DEPLOYMENT.md) -- production configuration and horizontal scaling
- [Django Channels Deployment](https://channels.readthedocs.io/en/latest/deploying.html)
