# Internationalization (i18n)

djust provides seamless internationalization support that integrates with Django's i18n system while enabling **live language switching** without page reloads.

## Quick Start

```python
from djust import LiveView
from djust.i18n import I18nMixin
from djust.decorators import event_handler
from django.utils.translation import gettext as _

class MultilingualView(I18nMixin, LiveView):
    template_name = 'myview.html'
    
    def mount(self, request, **kwargs):
        # Language auto-detected from request
        self.welcome_message = _("Welcome!")
    
    @event_handler
    def change_language(self, lang):
        self.set_language(lang)
        # Re-translate after language change
        self.welcome_message = _("Welcome!")
```

```html
<!-- myview.html -->
{% load djust_i18n %}

<!-- Initialize JavaScript i18n -->
{% djust_i18n_js "Welcome!" "Save" "Cancel" %}

<div dir="{{ text_direction }}">
    <h1>{{ welcome_message }}</h1>
    
    <!-- Language selector -->
    {% djust_language_select class="form-select" %}
</div>
```

## Features

### 1. I18nMixin

The `I18nMixin` provides full i18n support for your LiveViews:

```python
from djust.i18n import I18nMixin

class MyView(I18nMixin, LiveView):
    # Optional: override default language
    default_language = 'en'
    
    # Whether to persist language preference
    persist_language = True  # default
    
    # Session key for language storage
    language_session_key = 'djust_language'
    
    # Cookie name for language preference
    language_cookie_name = 'djust_lang'
```

#### Properties

- `language`: Current language code (e.g., `'en'`, `'es'`, `'ar'`)
- `is_rtl`: `True` if current language is right-to-left
- `text_direction`: `'rtl'` or `'ltr'`
- `available_languages`: List of `(code, name)` tuples from Django settings

#### Methods

```python
# Set language (triggers live update)
self.set_language('es')

# Get translation context for templates
ctx = self.get_i18n_context()
# Returns: {'language': 'es', 'is_rtl': False, 'text_direction': 'ltr', ...}
```

### 2. Live Language Switching

Change language without page reload:

```python
@event_handler
def change_language(self, lang):
    self.set_language(lang)
    # Update any translated content
    self.title = _("Dashboard")
    self.status = _("Active")
```

The `set_language()` method:
- Activates Django's translation for the new language
- Updates the `<html lang>` attribute
- Updates the `dir` attribute for RTL/LTR
- Persists the preference to session/cookie
- Triggers a re-render with new translations

### 3. JavaScript i18n

Expose translations to JavaScript with the `{% djust_i18n_js %}` tag:

```html
{% load djust_i18n %}

<!-- Basic setup (metadata only) -->
{% djust_i18n_js %}

<!-- Include specific translations -->
{% djust_i18n_js "Hello" "Save" "Cancel" "Delete" %}
```

This creates `window.djust.i18n` with:

```javascript
// Access translations
window.djust.i18n.get('Hello')  // Returns translated string
window.djust.i18n.get('Unknown', 'Fallback')  // With fallback

// Language info
window.djust.i18n.lang      // 'es'
window.djust.i18n.isRtl     // false
window.djust.i18n.dir       // 'ltr'

// Check if language is RTL
window.djust.i18n.isRtlLanguage('ar')  // true

// Add translations dynamically
window.djust.i18n.addTranslations({
    'New Key': 'Nueva Clave'
})
```

#### JavaScript Formatting

```javascript
// Number formatting
window.djust.i18n.formatNumber(1234567.89)  // "1,234,567.89"

// Currency formatting
window.djust.i18n.formatCurrency(99.99, 'USD')  // "$99.99"
window.djust.i18n.formatCurrency(99.99, 'EUR')  // "€99.99"

// Percentage
window.djust.i18n.formatPercent(0.15)  // "15%"

// Date formatting
window.djust.i18n.formatDate(new Date(), 'long')
window.djust.i18n.formatTime(new Date(), 'short')
window.djust.i18n.formatDateTime(new Date(), 'medium')

// Relative time
window.djust.i18n.formatRelativeTime(pastDate)  // "2 hours ago"

// List formatting
window.djust.i18n.formatList(['Apple', 'Banana', 'Cherry'])
// "Apple, Banana, and Cherry"

// Pluralization
window.djust.i18n.plural(count, {
    one: '1 item',
    other: '{count} items'
})
```

### 4. RTL Support

djust automatically detects RTL languages and updates the document direction.

#### Supported RTL Languages

Arabic (ar), Aramaic (arc), Divehi (dv), Persian (fa), Hausa (ha), Hebrew (he), Khowar (khw), Kashmiri (ks), Kurdish (ku), Pashto (ps), Urdu (ur), Yiddish (yi)

#### Template Tags for RTL

```html
{% load djust_i18n %}

<!-- Get text direction -->
<div dir="{% djust_text_dir %}">Content</div>

<!-- RTL-conditional classes -->
<div class="container {% djust_rtl_class 'text-right' 'text-left' %}">
    Content aligned according to language
</div>

<!-- Check if RTL -->
{% if djust_is_rtl %}
    <link rel="stylesheet" href="{% static 'css/rtl.css' %}">
{% endif %}
```

#### RTL-Aware CSS Classes

djust injects RTL-aware utility classes automatically:

```html
<!-- Text alignment -->
<p class="djust-text-start">Aligns left in LTR, right in RTL</p>
<p class="djust-text-end">Aligns right in LTR, left in RTL</p>

<!-- Margins/Padding (start/end) -->
<div class="djust-ms-3">Margin-start: 1rem</div>
<div class="djust-pe-2">Padding-end: 0.5rem</div>

<!-- Float -->
<div class="djust-float-start">Floats left in LTR, right in RTL</div>

<!-- Flex direction -->
<div class="djust-flex-row">Row in LTR, row-reverse in RTL</div>
```

#### Dynamic RTL Updates

Use data attributes for elements that should update on language change:

```html
<!-- Class switching -->
<div data-rtl-class="text-right pl-4" data-ltr-class="text-left pr-4">
    Content
</div>

<!-- Style switching -->
<div data-rtl-style="margin-right: 20px" data-ltr-style="margin-left: 20px">
    Content
</div>
```

### 5. Locale-Aware Formatting

Format dates, numbers, and currency according to the user's locale:

#### Python (in LiveView)

```python
from datetime import date, datetime
from decimal import Decimal

class ReportView(I18nMixin, LiveView):
    def mount(self, request, **kwargs):
        today = date.today()
        
        # Date formatting
        self.date_short = self.format_date(today, 'short')   # "1/15/24"
        self.date_long = self.format_date(today, 'long')     # "January 15, 2024"
        
        # Datetime formatting
        now = datetime.now()
        self.datetime = self.format_datetime(now, 'medium')
        
        # Time formatting
        self.time = self.format_time(now, 'short')  # "2:30 PM"
        
        # Number formatting (uses locale separators)
        self.big_number = self.format_number(1234567.89)  # "1,234,567.89"
        
        # Decimal with precision
        self.precise = self.format_decimal(3.14159, decimal_places=2)  # "3.14"
        
        # Currency
        self.price_usd = self.format_currency(99.99, 'USD')  # "$99.99"
        self.price_eur = self.format_currency(99.99, 'EUR')  # "€99.99"
        
        # Percentage (0.5 = 50%)
        self.completion = self.format_percent(0.75)  # "75%"
```

#### Standalone Functions

```python
from djust.i18n import (
    format_date,
    format_datetime,
    format_time,
    format_number,
    format_currency,
    format_percent,
    format_decimal,
)

# All functions accept an optional locale parameter
format_date(date.today(), 'long', 'de')      # "15. Januar 2024"
format_number(1234.56, 'de')                  # "1.234,56"
format_currency(99.99, 'EUR', 'de')          # "99,99 €"
```

#### Template Filters

```html
{% load djust_i18n %}

<!-- Number formatting -->
{{ total|format_number_i18n }}
{{ value|format_number_i18n:"de" }}

<!-- Currency formatting -->
{{ price|format_currency_i18n:"USD" }}
{{ price|format_currency_i18n:"EUR:de" }}

<!-- Date formatting -->
{{ event_date|format_date_i18n:"long" }}
{{ created_at|format_datetime_i18n:"short:fr" }}

<!-- Percentage -->
{{ completion_rate|format_percent_i18n }}
```

## Language Switcher Components

### Dropdown Select

```html
{% djust_language_select class="form-select" id="lang-picker" %}
```

Renders a `<select>` with `dj-change="change_language"` automatically.

### Button Group

```html
{% djust_language_buttons class="btn btn-sm" active_class="btn-primary" inactive_class="btn-outline-secondary" %}
```

### Dropdown Menu

```html
{% djust_language_menu %}
```

Requires Bootstrap or similar CSS framework.

### Custom Implementation

```html
<div class="language-picker">
    {% for code, name in available_languages %}
        <button dj-click="change_language" 
                dj-value-lang="{{ code }}"
                class="{% if code == language %}active{% endif %}">
            {{ name }}
        </button>
    {% endfor %}
</div>
```

## Django Settings

Configure available languages in `settings.py`:

```python
# Enable i18n
USE_I18N = True
USE_L10N = True

# Default language
LANGUAGE_CODE = 'en'

# Available languages
LANGUAGES = [
    ('en', 'English'),
    ('es', 'Español'),
    ('fr', 'Français'),
    ('de', 'Deutsch'),
    ('ar', 'العربية'),
    ('he', 'עברית'),
    ('ja', '日本語'),
    ('zh-hans', '简体中文'),
]

# Locale paths for translation files
LOCALE_PATHS = [
    BASE_DIR / 'locale',
]
```

## Translation Files

### Creating Translations

```bash
# Extract messages
python manage.py makemessages -l es

# Compile translations
python manage.py compilemessages
```

### Translation File Structure

```
myapp/
└── locale/
    ├── es/
    │   └── LC_MESSAGES/
    │       ├── django.po
    │       └── django.mo
    └── fr/
        └── LC_MESSAGES/
            ├── django.po
            └── django.mo
```

## Events

### Language Change Event

Listen for language changes in JavaScript:

```javascript
window.addEventListener('djust:language-changed', function(event) {
    console.log('Language changed to:', event.detail.lang);
    console.log('Is RTL:', event.detail.isRtl);
    console.log('Direction:', event.detail.dir);
    
    // Update any language-specific elements
    updateLanguageSpecificContent();
});
```

## Best Practices

### 1. Re-translate After Language Change

```python
@event_handler
def change_language(self, lang):
    self.set_language(lang)
    # Re-translate all user-visible strings
    self.title = _("Dashboard")
    self.button_label = _("Submit")
    self.status_messages = {
        'success': _("Operation successful"),
        'error': _("An error occurred"),
    }
```

### 2. Use Context Variables

Include i18n context in your template context:

```python
def get_context_data(self, **kwargs):
    context = super().get_context_data(**kwargs)
    context.update(self.get_i18n_context())
    return context
```

### 3. Preload Common Translations

```html
{% djust_i18n_js "Save" "Cancel" "Delete" "Edit" "Loading..." "Error" %}
```

### 4. RTL-First CSS

Design with RTL in mind from the start:

```css
/* Use logical properties */
.card {
    padding-inline-start: 1rem;  /* instead of padding-left */
    margin-inline-end: 0.5rem;   /* instead of margin-right */
}
```

### 5. Test RTL Layouts

```python
def test_rtl_rendering(self):
    view = MyView()
    view._init_i18n()
    view.set_language('ar')
    
    assert view.is_rtl is True
    assert view.text_direction == 'rtl'
```

## Babel Dependency

For advanced formatting (proper locale-aware number/currency/date formatting), install Babel:

```bash
pip install babel
```

Without Babel, djust falls back to basic Python formatting which may not respect all locale conventions.

## API Reference

### I18nMixin

| Property/Method | Description |
|----------------|-------------|
| `language` | Current language code |
| `is_rtl` | Whether current language is RTL |
| `text_direction` | `'rtl'` or `'ltr'` |
| `available_languages` | List of `(code, name)` tuples |
| `set_language(lang)` | Change language (triggers update) |
| `mount_i18n(request)` | Initialize i18n from request |
| `get_i18n_context()` | Get context dict for templates |
| `format_date(value, format, locale)` | Format a date |
| `format_datetime(value, format, locale)` | Format a datetime |
| `format_time(value, format, locale)` | Format a time |
| `format_number(value, locale)` | Format a number |
| `format_currency(value, currency, locale)` | Format currency |
| `format_percent(value, locale)` | Format percentage |
| `format_decimal(value, places, locale)` | Format decimal |
| `gettext(message)` | Translate string |
| `ngettext(singular, plural, n)` | Pluralized translation |
| `pgettext(context, message)` | Context-aware translation |

### Template Tags

| Tag | Description |
|-----|-------------|
| `{% djust_i18n_js %}` | Output i18n JavaScript setup |
| `{% djust_translations_json %}` | Output translations as JSON |
| `{% djust_language_select %}` | Render language dropdown |
| `{% djust_language_buttons %}` | Render language buttons |
| `{% djust_language_menu %}` | Render language dropdown menu |
| `{% djust_rtl_class %}` | Output RTL/LTR class |
| `{% djust_text_dir %}` | Output text direction |
| `{% djust_is_rtl %}` | Boolean RTL check |

### Template Filters

| Filter | Description |
|--------|-------------|
| `format_number_i18n` | Format number with locale |
| `format_currency_i18n` | Format currency with locale |
| `format_date_i18n` | Format date with locale |
| `format_datetime_i18n` | Format datetime with locale |
| `format_percent_i18n` | Format percentage with locale |
