{% load djust_tags %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Change Form - Djust LiveView</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .section-card {
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .section-header:hover {
            opacity: 0.95;
        }
        .section-header.collapsed {
            background: #6c757d;
        }
        .tofrom-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            align-items: start;
        }
        .tofrom-previous {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
        }
        .tofrom-new {
            background: #e7f3ff;
            padding: 1rem;
            border-radius: 0.25rem;
            border: 2px solid #0d6efd;
        }
        .calculated-field {
            background: #fffbf0;
            border-left: 3px solid #ffc107;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container py-5" @djust-connect>
        <h1 class="mb-4">
            <i class="fas fa-user-edit"></i>
            Employee Status Change Form
        </h1>

        {% if success_message %}
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> {{ success_message }}
        </div>
        {% endif %}

        {% if error_message %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> {{ error_message }}
        </div>
        {% endif %}

        <form @submit="submit_form">

            <!-- Employee Information Section -->
            <div class="card section-card">
                <div class="section-header" @click="toggle_section('employee_info')">
                    <i class="fas fa-user"></i>
                    <h5 class="mb-0 flex-grow-1">Employee Information</h5>
                    <i class="fas fa-chevron-{{ sections_expanded.employee_info|yesno:'up,down' }}"></i>
                </div>
                {% if sections_expanded.employee_info %}
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Employee *</label>
                            {{ form.employee }}
                            {% if form.employee.errors %}
                            <div class="invalid-feedback d-block">{{ form.employee.errors }}</div>
                            {% endif %}
                            {# Fire event when employee changes #}
                            <select @change="on_employee_change" style="display:none"></select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Business Line *</label>
                            {{ form.business_line }}
                            {% if form.business_line.errors %}
                            <div class="invalid-feedback d-block">{{ form.business_line.errors }}</div>
                            {% endif %}
                            {# Fire event when business line changes to filter executive approvers #}
                            <select @change="on_business_line_change" style="display:none"></select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Executive Approver *</label>
                            {{ form.executive_approver }}
                            <small class="form-text text-muted">
                                Filtered based on selected business line
                            </small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Effective Date *</label>
                            {{ form.effective_date }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Company Changes Section (ToFrom Pattern) -->
            <div class="card section-card">
                <div class="section-header" @click="toggle_section('company_changes')">
                    <i class="fas fa-building"></i>
                    <h5 class="mb-0 flex-grow-1">Change Company</h5>
                    <i class="fas fa-chevron-{{ sections_expanded.company_changes|yesno:'up,down' }}"></i>
                </div>
                {% if sections_expanded.company_changes %}
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            {{ form.needs_company }}
                            <label class="form-check-label" for="{{ form.needs_company.id_for_label }}">
                                Change Company?
                            </label>
                        </div>
                    </div>

                    {% if show_company_fields %}
                    <div class="tofrom-layout">
                        <div class="tofrom-previous">
                            <label class="form-label">Previous Company</label>
                            {{ form.previous_company }}
                            <small class="text-muted">Auto-populated from employee profile</small>
                        </div>
                        <div class="tofrom-new">
                            <label class="form-label">New Company *</label>
                            {{ form.new_company }}
                            {% if form.new_company.errors %}
                            <div class="invalid-feedback d-block">{{ form.new_company.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Supervisor Changes Section (ToFrom Pattern) -->
            <div class="card section-card">
                <div class="section-header" @click="toggle_section('supervisor_changes')">
                    <i class="fas fa-users"></i>
                    <h5 class="mb-0 flex-grow-1">Change Supervisor</h5>
                    <i class="fas fa-chevron-{{ sections_expanded.supervisor_changes|yesno:'up,down' }}"></i>
                </div>
                {% if sections_expanded.supervisor_changes %}
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            {{ form.needs_supervisor }}
                            <label class="form-check-label" for="{{ form.needs_supervisor.id_for_label }}">
                                Change Supervisor?
                            </label>
                        </div>
                    </div>

                    {% if show_supervisor_fields %}
                    <div class="tofrom-layout">
                        <div class="tofrom-previous">
                            <label class="form-label">Previous Supervisor</label>
                            {{ form.previous_supervisor }}
                            <small class="text-muted">Auto-populated from employee profile</small>
                        </div>
                        <div class="tofrom-new">
                            <label class="form-label">New Supervisor *</label>
                            {{ form.new_supervisor }}
                            {% if form.new_supervisor.errors %}
                            <div class="invalid-feedback d-block">{{ form.new_supervisor.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Project Information Section (Needs Pattern) -->
            <div class="card section-card">
                <div class="section-header" @click="toggle_section('project_info')">
                    <i class="fas fa-clipboard-list"></i>
                    <h5 class="mb-0 flex-grow-1">Add Project Information</h5>
                    <i class="fas fa-chevron-{{ sections_expanded.project_info|yesno:'up,down' }}"></i>
                </div>
                {% if sections_expanded.project_info %}
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            {{ form.needs_projects }}
                            <label class="form-check-label" for="{{ form.needs_projects.id_for_label }}">
                                Add Project Information?
                            </label>
                        </div>
                    </div>

                    {% if show_project_fields %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Project Number</label>
                            {{ form.project_number }}
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Project Duration</label>
                            {{ form.project_duration }}
                            {# Fire event when duration changes to show/hide expected_end_date #}
                            <select @change="on_project_duration_change" style="display:none"></select>
                        </div>

                        {% if show_expected_end_date %}
                        <div class="col-md-6">
                            <label class="form-label">Expected End Date *</label>
                            {{ form.expected_end_date }}
                            <small class="form-text text-muted">
                                Required for projects exceeding 12 months
                            </small>
                            {% if form.expected_end_date.errors %}
                            <div class="invalid-feedback d-block">{{ form.expected_end_date.errors }}</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Meals Per Diem Section (Needs Pattern with Calculations) -->
            <div class="card section-card">
                <div class="section-header" @click="toggle_section('meals_per_diem')">
                    <i class="fas fa-utensils"></i>
                    <h5 class="mb-0 flex-grow-1">Add Meals Per Diem</h5>
                    <i class="fas fa-chevron-{{ sections_expanded.meals_per_diem|yesno:'up,down' }}"></i>
                </div>
                {% if sections_expanded.meals_per_diem %}
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            {{ form.needs_meals_per_diem }}
                            <label class="form-check-label" for="{{ form.needs_meals_per_diem.id_for_label }}">
                                Employee needs meals per diem?
                            </label>
                        </div>
                    </div>

                    {% if show_meals_fields %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Days Per Month on Jobsite</label>
                            {{ form.days_per_month_on_job_site }}
                            {# Fire calculation when this changes #}
                            <input type="text" @input="calculate_monthly_per_diem" style="display:none">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Per Diem Rate for Area</label>
                            {{ form.new_meals_per_diem_amount }}
                            {# Fire calculation when this changes #}
                            <input type="text" @input="calculate_monthly_per_diem" style="display:none">
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="fas fa-calculator"></i>
                                Total Monthly Meals Per Diem
                            </label>
                            {{ form.total_monthly_meals_per_diem }}
                            <small class="form-text text-muted">
                                Automatically calculated: Days Ã— Rate
                            </small>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Additional Notes Section -->
            <div class="card section-card">
                <div class="section-header">
                    <i class="fas fa-info-circle"></i>
                    <h5 class="mb-0">Additional Notes</h5>
                </div>
                <div class="card-body">
                    {{ form.notes }}
                </div>
            </div>

            <!-- Supervisor Signature Section -->
            <div class="card section-card">
                <div class="section-header">
                    <i class="fas fa-signature"></i>
                    <h5 class="mb-0">Supervisor Signature</h5>
                </div>
                <div class="card-body">
                    <label class="form-label">Supervisor Signature *</label>
                    {{ form.supervisor_signature }}
                    {% if form.supervisor_signature.errors %}
                    <div class="invalid-feedback d-block">{{ form.supervisor_signature.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-paper-plane"></i>
                    Submit Status Change
                </button>
            </div>

        </form>
    </div>

    <!-- Djust LiveView Client (~5KB) -->
    <script src="{% static 'djust/client.js' %}"></script>
</body>
</html>
